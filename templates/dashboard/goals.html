{% extends "base.html" %}

{% block title %}Goals & Profile - Smart Diet Planner{% endblock %}


{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-bullseye"></i> Goals & Profile
                </h1>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('auth.preferences') }}" class="btn btn-outline-info">
                        <i class="fas fa-cog"></i> Preferences
                    </a>
                    <a href="{{ url_for('dashboard.home') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-home"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">BMR</h6>
                            <h3>{{ user_stats.bmr }}</h3>
                            <small>Calories/day</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-heartbeat display-4"></i>
                        </div>
                    </div>
                    <small class="opacity-75">Basal Metabolic Rate</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">TDEE</h6>
                            <h3>{{ user_stats.tdee }}</h3>
                            <small>Calories/day</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-bolt display-4"></i>
                        </div>
                    </div>
                    <small class="opacity-75">Total Daily Energy</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card 
                {% if user_stats.bmi_category == 'Normal weight' %}bg-success
                {% elif user_stats.bmi_category == 'Underweight' %}bg-info
                {% elif user_stats.bmi_category == 'Overweight' %}bg-warning
                {% else %}bg-danger
                {% endif %} text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">BMI</h6>
                            <h3>{{ user_stats.bmi }}</h3>
                            <small>{{ user_stats.bmi_category }}</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user display-4"></i>
                        </div>
                    </div>
                    <small class="opacity-75">Body Mass Index</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card stat-card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Activity</h6>
                            <h3 style="font-size: 1rem;">{{ current_user.activity_level }}</h3>
                            <small>Current level</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-running display-4"></i>
                        </div>
                    </div>
                    <small class="opacity-75">Exercise frequency</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Goals Setting -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bullseye"></i> Nutrition Goals
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('api.update_goals') }}">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="daily_calorie_goal" class="form-label">Daily Calorie Goal</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="daily_calorie_goal" 
                                           name="daily_calorie_goal" min="1000" max="5000" step="50"
                                           value="{{ current_user.daily_calorie_goal or user_stats.tdee }}" required>
                                    <span class="input-group-text">cal</span>
                                </div>
                                <div class="form-text">
                                    Recommended: {{ user_stats.tdee }} calories (based on your TDEE)
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="protein_goal" class="form-label">Daily Protein Goal</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="protein_goal" 
                                           name="protein_goal" min="30" max="300" step="5"
                                           value="{{ current_user.protein_goal or ((current_user.daily_calorie_goal or user_stats.tdee) * 0.25 / 4)|round(0) }}">
                                    <span class="input-group-text">g</span>
                                </div>
                                <div class="form-text">
                                    Recommended: {{ ((current_user.daily_calorie_goal or user_stats.tdee) * 0.25 / 4)|round(0) }}g (25% of calories)
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="carb_goal" class="form-label">Daily Carbohydrate Goal</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="carb_goal" 
                                           name="carb_goal" min="50" max="500" step="5"
                                           value="{{ current_user.carb_goal or ((current_user.daily_calorie_goal or user_stats.tdee) * 0.45 / 4)|round(0) }}">
                                    <span class="input-group-text">g</span>
                                </div>
                                <div class="form-text">
                                    Recommended: {{ ((current_user.daily_calorie_goal or user_stats.tdee) * 0.45 / 4)|round(0) }}g (45% of calories)
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="fat_goal" class="form-label">Daily Fat Goal</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="fat_goal" 
                                           name="fat_goal" min="20" max="200" step="5"
                                           value="{{ current_user.fat_goal or ((current_user.daily_calorie_goal or user_stats.tdee) * 0.30 / 9)|round(0) }}">
                                    <span class="input-group-text">g</span>
                                </div>
                                <div class="form-text">
                                    Recommended: {{ ((current_user.daily_calorie_goal or user_stats.tdee) * 0.30 / 9)|round(0) }}g (30% of calories)
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Macro Distribution:</strong> These goals follow a balanced 25% protein, 45% carbs, 30% fat distribution.
                                    Adjust based on your specific fitness or health goals.
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check-circle"></i> Update Goals
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetToRecommended()">
                                <i class="fas fa-redo"></i> Reset to Recommended
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb"></i> Goal Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6><i class="fas fa-bullseye text-success"></i> Weight Goals</h6>
                        <ul class="list-unstyled small">
                            {% if user_stats.bmi_category == 'Underweight' %}
                            <li><i class="bi bi-arrow-up text-info"></i> Weight gain: +300-500 cal above TDEE</li>
                            {% elif user_stats.bmi_category == 'Overweight' or user_stats.bmi_category == 'Obese' %}
                            <li><i class="bi bi-arrow-down text-warning"></i> Weight loss: -300-500 cal below TDEE</li>
                            {% else %}
                            <li><i class="bi bi-check-circle text-success"></i> Maintenance: Stay around TDEE</li>
                            {% endif %}
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <h6><i class="bi bi-heart text-danger"></i> Health Focus</h6>
                        <ul class="list-unstyled small">
                            {% if current_user.is_diabetic %}
                            <li><i class="bi bi-shield-check"></i> Focus on low GI carbs</li>
                            <li><i class="bi bi-graph-down"></i> Consider lower carb ratio</li>
                            {% endif %}
                            <li><i class="bi bi-droplet"></i> Include healthy fats</li>
                            <li><i class="bi bi-cup-hot"></i> Stay hydrated (8-10 glasses/day)</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h6><i class="bi bi-activity text-primary"></i> Activity Tips</h6>
                        <ul class="list-unstyled small">
                            {% if current_user.activity_level == 'Sedentary' %}
                            <li><i class="bi bi-clock"></i> Try 30min walking daily</li>
                            {% elif current_user.activity_level == 'Very Active' %}
                            <li><i class="bi bi-trophy"></i> Consider higher protein intake</li>
                            {% endif %}
                            <li><i class="bi bi-calendar-check"></i> Update activity level when routine changes</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Information -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person-badge"></i> Profile Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <strong>Name:</strong><br>
                            {{ current_user.first_name }} {{ current_user.last_name }}
                        </div>
                        <div class="col-6">
                            <strong>Age:</strong><br>
                            {{ current_user.age }} years
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>Height:</strong><br>
                            {{ current_user.height }} cm
                        </div>
                        <div class="col-6">
                            <strong>Weight:</strong><br>
                            {{ current_user.weight }} kg
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>Gender:</strong><br>
                            {{ current_user.gender }}
                        </div>
                        <div class="col-6">
                            <strong>Diet Type:</strong><br>
                            <span class="badge bg-{{ 'success' if current_user.food_preferences == 'Vegetarian' else 'warning' }}">
                                {{ current_user.food_preferences }}
                            </span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="{{ url_for('auth.profile') }}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i> Update Profile
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> Progress Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="row">
                            <div class="col-4">
                                <div class="border-end">
                                    <h4 class="text-primary mb-0">{{ user_stats.total_logs }}</h4>
                                    <small class="text-muted">Meals Logged</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="border-end">
                                    <h4 class="text-success mb-0">{{ user_stats.total_days }}</h4>
                                    <small class="text-muted">Days Tracked</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <h4 class="text-info mb-0">{{ user_stats.avg_goal_achievement }}%</h4>
                                <small class="text-muted">Avg Goal Achievement</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('dashboard.progress') }}" class="btn btn-outline-info">
                            <i class="bi bi-graph-up"></i> View Detailed Progress
                        </a>
                        <a href="{{ url_for('dashboard.recommendations') }}" class="btn btn-outline-success">
                            <i class="bi bi-lightbulb"></i> Get Food Recommendations
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BMI Information -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Understanding Your Health Metrics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>BMR (Basal Metabolic Rate)</h6>
                            <p class="small text-muted">
                                The number of calories your body needs to maintain basic functions at rest. 
                                This includes breathing, circulation, and cellular processes.
                            </p>
                        </div>
                        <div class="col-md-4">
                            <h6>TDEE (Total Daily Energy Expenditure)</h6>
                            <p class="small text-muted">
                                Your BMR plus calories burned through activities and exercise. 
                                This is approximately how many calories you burn in a day.
                            </p>
                        </div>
                        <div class="col-md-4">
                            <h6>BMI Categories</h6>
                            <ul class="small text-muted list-unstyled">
                                <li><span class="badge bg-info">Under 18.5</span> Underweight</li>
                                <li><span class="badge bg-success">18.5-24.9</span> Normal weight</li>
                                <li><span class="badge bg-warning">25-29.9</span> Overweight</li>
                                <li><span class="badge bg-danger">30+</span> Obese</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function resetToRecommended() {
    const tdee = {{ user_stats.tdee }};
    const protein = Math.round(tdee * 0.25 / 4);
    const carbs = Math.round(tdee * 0.45 / 4);
    const fat = Math.round(tdee * 0.30 / 9);
    
    document.getElementById('daily_calorie_goal').value = tdee;
    document.getElementById('protein_goal').value = protein;
    document.getElementById('carb_goal').value = carbs;
    document.getElementById('fat_goal').value = fat;
}

// Auto-calculate macro goals when calorie goal changes
document.getElementById('daily_calorie_goal').addEventListener('input', function() {
    const calories = parseInt(this.value) || 0;
    if (calories > 0) {
        const protein = Math.round(calories * 0.25 / 4);
        const carbs = Math.round(calories * 0.45 / 4);
        const fat = Math.round(calories * 0.30 / 9);
        
        // Update the form text to show new recommendations
        document.querySelector('label[for="protein_goal"] + .input-group + .form-text').innerHTML = 
            `Recommended: ${protein}g (25% of calories)`;
        document.querySelector('label[for="carb_goal"] + .input-group + .form-text').innerHTML = 
            `Recommended: ${carbs}g (45% of calories)`;
        document.querySelector('label[for="fat_goal"] + .input-group + .form-text').innerHTML = 
            `Recommended: ${fat}g (30% of calories)`;
    }
});
</script>
{% endblock %}